<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Grades Judo</title>
    <script src="auth.js"></script>
</head>
<body>
    <h1>ğŸ¥‹ Administration Grades Judo</h1>
    
    <div id="message" style="position: fixed; top: 20px; right: 20px; padding: 1rem; border-radius: 8px; display: none; z-index: 1000;"></div>
    
    <div class="onglets">
        <button class="onglet active" onclick="afficherOnglet('grades')">ğŸ¥‹ Grades</button>
        <button class="onglet" onclick="afficherOnglet('techniques')">ğŸ’ª Techniques</button>
        <button class="onglet" onclick="afficherOnglet('katas')">ğŸ“¿ Katas</button>
        <button class="onglet" onclick="afficherOnglet('philosophie')">ğŸ§  Philosophie</button>
        <button class="onglet" onclick="afficherOnglet('reglement')">ğŸ“ RÃ¨glement</button>
        <button class="onglet" onclick="afficherOnglet('nouveautes')">ğŸ”„ NouveautÃ©s</button>
        <button class="onglet" onclick="afficherOnglet('pdf')">ğŸ“„ Documents PDF</button>
        <button class="onglet" onclick="afficherOnglet('sauvegarde')" style="background: #e67e22;">ğŸ’¾ Sauvegarde</button>
    </div>
    
    <!-- GRADES -->
    <div id="onglet-grades" class="contenu-onglet active">
        <h2>Gestion des Grades</h2>
        <div id="grade-selector"></div>
        <textarea id="content-grade" rows="10"></textarea>
        <button onclick="sauvegarderGrade()">ğŸ’¾ Sauvegarder</button>
    </div>
    
    <!-- TECHNIQUES -->
    <div id="onglet-techniques" class="contenu-onglet">
        <h2>Gestion des Techniques</h2>
        <button onclick="afficherTechnique('1er-dan')">1er Dan</button>
        <button onclick="afficherTechnique('2eme-dan')">2Ã¨me Dan</button>
        <button onclick="afficherTechnique('3eme-dan')">3Ã¨me Dan</button>
        <button onclick="afficherTechnique('4-5-6-dan')">4-5-6 Dan</button>
        <button onclick="afficherTechnique('20-attaques')">20 Attaques</button>
        <textarea id="technique-text" rows="10"></textarea>
        <button onclick="sauvegarderTechnique()">ğŸ’¾ Sauvegarder</button>
    </div>
    
    <!-- KATAS -->
    <div id="onglet-katas" class="contenu-onglet">
        <h2>Gestion des Katas</h2>
        <button onclick="afficherKata('nage-no-kata')">Nage-no-kata</button>
        <button onclick="afficherKata('katame-no-kata')">Katame-no-kata</button>
        <button onclick="afficherKata('kime-no-kata')">Kime-no-kata</button>
        <button onclick="afficherKata('goshin-jitsu')">Goshin-jitsu</button>
        <button onclick="afficherKata('ju-no-kata')">Ju-no-kata</button>
        <button onclick="afficherKata('itsutsu-no-kata')">Itsutsu-no-kata</button>
        <button onclick="afficherKata('koshiki-no-kata')">Koshiki-no-kata</button>
        <button onclick="afficherKata('gonosen')">Gonosen</button>
        <textarea id="kata-text" rows="10"></textarea>
        <button onclick="sauvegarderKata()">ğŸ’¾ Sauvegarder</button>
    </div>
    
    <!-- PHILOSOPHIE -->
    <div id="onglet-philosophie" class="contenu-onglet">
        <h2>Gestion Philosophie</h2>
        <button onclick="afficherPhilo('shin-gi-tai')">Shin-Gi-Tai</button>
        <button onclick="afficherPhilo('ethique')">Ã‰thique</button>
        <button onclick="afficherPhilo('principes')">Principes</button>
        <button onclick="afficherPhilo('histoire')">Histoire</button>
        <textarea id="philo-text" rows="10"></textarea>
        <button onclick="sauvegarderPhilo()">ğŸ’¾ Sauvegarder</button>
    </div>
    
    <!-- REGLEMENT -->
    <div id="onglet-reglement" class="contenu-onglet">
        <h2>RÃ¨glement GÃ©nÃ©ral</h2>
        <textarea id="reglement-general" rows="5"></textarea>
        <button onclick="sauvegarderReglementSection('general')">ğŸ’¾ Sauvegarder</button>
        
        <h2>Guide des Juges</h2>
        <textarea id="reglement-juges" rows="5"></textarea>
        <button onclick="sauvegarderReglementSection('juges')">ğŸ’¾ Sauvegarder</button>
        
        <h2>CritÃ¨res Ã‰valuation</h2>
        <textarea id="reglement-criteres" rows="5"></textarea>
        <button onclick="sauvegarderReglementSection('criteres')">ğŸ’¾ Sauvegarder</button>
        
        <h2>ProcÃ©dure Examen</h2>
        <textarea id="reglement-procedure" rows="5"></textarea>
        <button onclick="sauvegarderReglementSection('procedure')">ğŸ’¾ Sauvegarder</button>
        
        <h2>NouveautÃ©s</h2>
        <textarea id="reglement-nouveautes" rows="5"></textarea>
        <button onclick="sauvegarderReglementSection('nouveautes')">ğŸ’¾ Sauvegarder</button>
    </div>
    
    <!-- NOUVEAUTES -->
    <div id="onglet-nouveautes" class="contenu-onglet">
        <h2>NouveautÃ©s</h2>
        <input type="text" id="nouveaute-1" placeholder="Titre 1">
        <textarea id="description-1" rows="3"></textarea>
        <input type="text" id="nouveaute-2" placeholder="Titre 2">
        <textarea id="description-2" rows="3"></textarea>
        <button onclick="sauvegarderNouveautes()">ğŸ’¾ Sauvegarder</button>
    </div>
    
    <!-- PDF (CORRIGÃ‰!) -->
    <div id="onglet-pdf" class="contenu-onglet">
        <h2>ğŸ“„ Gestion des Documents PDF</h2>
        <p style="color: #666;">Uploadez des PDF qui seront visibles sur la page Documents</p>
        
        <div style="border: 2px dashed #3498db; padding: 2rem; margin: 1rem 0; border-radius: 8px; background: #f8f9fa;">
            <h3 style="margin-top: 0;">ğŸ“¤ Ajouter un nouveau document</h3>
            
            <label style="display: block; margin-top: 1rem; font-weight: bold;">ğŸ“„ Fichier PDF :</label>
            <input type="file" id="pdf-upload" accept=".pdf" style="margin: 0.5rem 0; padding: 0.5rem;">
            
            <label style="display: block; margin-top: 1rem; font-weight: bold;">ğŸ“ Titre du document :</label>
            <input type="text" id="pdf-titre" placeholder="Ex: RÃ¨glement 2025" 
                   style="width: 100%; padding: 0.75rem; margin: 0.5rem 0; border: 2px solid #ddd; border-radius: 6px;">
            
            <label style="display: block; margin-top: 1rem; font-weight: bold;">ğŸ“‹ Description :</label>
            <textarea id="pdf-description" placeholder="Description du document..." rows="3"
                      style="width: 100%; padding: 0.75rem; margin: 0.5rem 0; border: 2px solid #ddd; border-radius: 6px;"></textarea>
            
            <label style="display: block; margin-top: 1rem; font-weight: bold;">ğŸ—‚ï¸ CatÃ©gorie :</label>
            <select id="pdf-categorie" style="width: 100%; padding: 0.75rem; margin: 0.5rem 0; border: 2px solid #ddd; border-radius: 6px;">
                <option value="reglement-general">ğŸ“œ RÃ¨glement GÃ©nÃ©ral</option>
                <option value="juges-arbitres">ğŸ‘” Juges & Arbitres</option>
                <option value="criteres-notation">âœ… CritÃ¨res de Notation</option>
                <option value="procedures">âš™ï¸ ProcÃ©dures</option>
                <option value="nouveautes">â­ NouveautÃ©s</option>
                <option value="autres">ğŸ“ Autres</option>
            </select>
            
            <button onclick="uploaderPDF()" style="background: #27ae60; margin-top: 1rem; padding: 1rem 2rem; font-size: 1.1rem;">
                ğŸ“¤ Uploader le Document
            </button>
        </div>
        
        <div id="liste-pdf" style="margin-top: 2rem;"></div>
    </div>
    
    <!-- SAUVEGARDE (NOUVEAU!) -->
    <div id="onglet-sauvegarde" class="contenu-onglet">
        <h2>ğŸ’¾ Sauvegarde et Restauration</h2>
        <p style="color: #666; margin-bottom: 2rem;">ProtÃ©gez vos donnÃ©es en crÃ©ant des sauvegardes complÃ¨tes</p>
        
        <!-- Export -->
        <div style="background: #d4edda; border: 2px solid #c3e6cb; padding: 2rem; margin-bottom: 2rem; border-radius: 8px;">
            <h3 style="color: #155724; margin-top: 0;">ğŸ“¤ Exporter toutes les donnÃ©es</h3>
            <p style="color: #155724;">TÃ©lÃ©chargez un fichier contenant :</p>
            <ul style="color: #155724;">
                <li>âœ… Tous les textes des grades (1er au 6Ã¨me Dan)</li>
                <li>âœ… Tous les textes des techniques</li>
                <li>âœ… Tous les textes des katas</li>
                <li>âœ… Tous les textes de philosophie</li>
                <li>âœ… Toutes les sections du rÃ¨glement</li>
                <li>âœ… Toutes les nouveautÃ©s</li>
                <li>âœ… Tous les documents PDF uploadÃ©s</li>
            </ul>
            <button onclick="exporterTout()" style="background: #28a745; padding: 1rem 2rem; font-size: 1.1rem;">
                ğŸ“¥ TÃ©lÃ©charger la sauvegarde complÃ¨te
            </button>
            <p style="color: #666; margin-top: 1rem; font-size: 0.9rem;">Le fichier sera nommÃ© : grades-judo-backup-AAAA-MM-JJ.json</p>
        </div>
        
        <!-- Import -->
        <div style="background: #fff3cd; border: 2px solid #ffeaa7; padding: 2rem; border-radius: 8px;">
            <h3 style="color: #856404; margin-top: 0;">ğŸ“‚ Restaurer une sauvegarde</h3>
            <p style="color: #856404;">âš ï¸ <strong>Attention :</strong> Ceci remplacera toutes vos donnÃ©es actuelles par celles de la sauvegarde !</p>
            <input type="file" id="import-file" accept=".json" style="margin: 1rem 0; padding: 0.5rem;">
            <br>
            <button onclick="importerTout()" style="background: #ffc107; color: #000; padding: 1rem 2rem; font-size: 1.1rem;">
                ğŸ“¤ Restaurer depuis un fichier
            </button>
        </div>
        
        <!-- Informations -->
        <div style="background: #d1ecf1; border: 2px solid #bee5eb; padding: 1.5rem; margin-top: 2rem; border-radius: 8px;">
            <h3 style="color: #0c5460; margin-top: 0;">â„¹ï¸ Informations</h3>
            <div id="info-sauvegarde" style="color: #0c5460;">Chargement...</div>
        </div>
    </div>
    
    <div style="margin-top: 2rem; padding: 1rem; border-top: 2px solid #eee;">
        <a href="index.html" style="margin-right: 1rem;">ğŸ  Accueil</a>
        <a href="documents.html" style="margin-right: 1rem;">ğŸ“š Voir les Documents</a>
        <button onclick="location.reload()">ğŸ”„ RafraÃ®chir</button>
    </div>

<style>
body { font-family: Arial, sans-serif; padding: 2rem; max-width: 1200px; margin: 0 auto; background: #f5f5f5; }
h1 { color: #2c3e50; margin-bottom: 2rem; }
h2 { color: #2c3e50; margin-top: 2rem; }
h3 { color: #34495e; }
.onglets { display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
.onglet { padding: 0.75rem 1.5rem; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s; }
.onglet:hover { background: #2980b9; }
.onglet.active { background: #e74c3c; }
.contenu-onglet { display: none; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.contenu-onglet.active { display: block; }
textarea, input[type="text"] { width: 100%; padding: 0.75rem; margin: 0.5rem 0; border: 2px solid #ddd; border-radius: 6px; font-family: inherit; font-size: 1rem; }
textarea:focus, input[type="text"]:focus, select:focus { outline: none; border-color: #3498db; }
button { padding: 0.75rem 1.5rem; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 0.5rem; font-size: 1rem; transition: all 0.3s; }
button:hover { background: #219a52; transform: translateY(-1px); }
#message { box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-weight: bold; }
#message.success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
#message.error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
.pdf-item { 
    background: white; 
    padding: 1.5rem; 
    margin: 1rem 0; 
    border-radius: 8px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    border-left: 5px solid #27ae60;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s;
}
.pdf-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateX(5px);
}
.pdf-info { flex: 1; }
.pdf-title { font-size: 1.2rem; font-weight: bold; color: #2c3e50; margin-bottom: 0.5rem; }
.pdf-meta { color: #7f8c8d; font-size: 0.9rem; margin-top: 0.5rem; }
.pdf-category { 
    display: inline-block;
    background: #3498db; 
    color: white; 
    padding: 0.25rem 0.75rem; 
    border-radius: 12px; 
    font-size: 0.85rem;
    margin-right: 0.5rem;
}
.pdf-actions { display: flex; gap: 0.5rem; align-items: center; }
label { color: #34495e; font-size: 0.95rem; }
select { font-size: 1rem; }
a { color: #3498db; text-decoration: none; padding: 0.5rem 1rem; }
a:hover { text-decoration: underline; }
</style>

<script>
if (!auth || !auth.checkSession()) {
    alert('â›” AccÃ¨s refusÃ©');
    window.location.href = 'index.html';
}

const GRADES = ['1er-dan', '2eme-dan', '3eme-dan', '4eme-dan', '5eme-dan', '6eme-dan'];
let gradeActuel = '1er-dan';
let techniqueActuelle = '1er-dan';
let kataActuel = 'nage-no-kata';
let philoActuelle = 'shin-gi-tai';

document.addEventListener('DOMContentLoaded', function() {
    initialiserGrades();
    chargerContenuGrade();
    chargerNouveautes();
    chargerToutReglement();
    chargerTechnique();
    chargerKata();
    chargerPhilo();
    afficherPDFs();
});

function afficherOnglet(onglet) {
    document.querySelectorAll('.contenu-onglet').forEach(o => o.classList.remove('active'));
    document.querySelectorAll('.onglet').forEach(o => o.classList.remove('active'));
    document.getElementById('onglet-' + onglet).classList.add('active');
    event.target.classList.add('active');
    if (onglet === 'pdf') afficherPDFs();
    if (onglet === 'sauvegarde') afficherInfoSauvegarde();
}

function initialiserGrades() {
    const container = document.getElementById('grade-selector');
    GRADES.forEach(grade => {
        const btn = document.createElement('button');
        btn.textContent = grade;
        btn.onclick = () => { gradeActuel = grade; chargerContenuGrade(); };
        container.appendChild(btn);
    });
}

function chargerContenuGrade() {
    document.getElementById('content-grade').value = localStorage.getItem('grade-' + gradeActuel) || '';
}

function sauvegarderGrade() {
    const contenu = document.getElementById('content-grade').value;
    localStorage.setItem('grade-' + gradeActuel, contenu);
    afficherMessage('âœ… Grade sauvegardÃ© !');
}

function afficherTechnique(tech) {
    techniqueActuelle = tech;
    chargerTechnique();
}

function chargerTechnique() {
    document.getElementById('technique-text').value = localStorage.getItem('technique-' + techniqueActuelle) || '';
}

function sauvegarderTechnique() {
    const contenu = document.getElementById('technique-text').value;
    localStorage.setItem('technique-' + techniqueActuelle, contenu);
    afficherMessage('âœ… Technique sauvegardÃ©e !');
}

function afficherKata(kata) {
    kataActuel = kata;
    chargerKata();
}

function chargerKata() {
    document.getElementById('kata-text').value = localStorage.getItem('kata-' + kataActuel) || '';
}

function sauvegarderKata() {
    const contenu = document.getElementById('kata-text').value;
    localStorage.setItem('kata-' + kataActuel, contenu);
    afficherMessage('âœ… Kata sauvegardÃ© !');
}

function afficherPhilo(philo) {
    philoActuelle = philo;
    chargerPhilo();
}

function chargerPhilo() {
    document.getElementById('philo-text').value = localStorage.getItem('philo-' + philoActuelle) || '';
}

function sauvegarderPhilo() {
    const contenu = document.getElementById('philo-text').value;
    localStorage.setItem('philo-' + philoActuelle, contenu);
    afficherMessage('âœ… Philosophie sauvegardÃ©e !');
}

function chargerNouveautes() {
    document.getElementById('nouveaute-1').value = localStorage.getItem('nouveaute-1-titre') || '';
    document.getElementById('description-1').value = localStorage.getItem('nouveaute-1-desc') || '';
    document.getElementById('nouveaute-2').value = localStorage.getItem('nouveaute-2-titre') || '';
    document.getElementById('description-2').value = localStorage.getItem('nouveaute-2-desc') || '';
}

function sauvegarderNouveautes() {
    localStorage.setItem('nouveaute-1-titre', document.getElementById('nouveaute-1').value);
    localStorage.setItem('nouveaute-1-desc', document.getElementById('description-1').value);
    localStorage.setItem('nouveaute-2-titre', document.getElementById('nouveaute-2').value);
    localStorage.setItem('nouveaute-2-desc', document.getElementById('description-2').value);
    afficherMessage('âœ… NouveautÃ©s sauvegardÃ©es !');
}

function chargerToutReglement() {
    document.getElementById('reglement-general').value = localStorage.getItem('reglement-general') || '';
    document.getElementById('reglement-juges').value = localStorage.getItem('reglement-juges') || '';
    document.getElementById('reglement-criteres').value = localStorage.getItem('reglement-criteres') || '';
    document.getElementById('reglement-procedure').value = localStorage.getItem('reglement-procedure') || '';
    document.getElementById('reglement-nouveautes').value = localStorage.getItem('reglement-nouveautes') || '';
}

function sauvegarderReglementSection(section) {
    const contenu = document.getElementById('reglement-' + section).value;
    localStorage.setItem('reglement-' + section, contenu);
    afficherMessage('âœ… Section sauvegardÃ©e !');
}

// ===== GESTION DES PDF - VERSION CORRIGÃ‰E =====
function uploaderPDF() {
    const fileInput = document.getElementById('pdf-upload');
    const titreInput = document.getElementById('pdf-titre');
    const descriptionInput = document.getElementById('pdf-description');
    const categorieSelect = document.getElementById('pdf-categorie');
    const file = fileInput.files[0];
    
    console.log('ğŸ“„ DÃ©but upload PDF...');
    
    // Validations
    if (!file) {
        afficherMessage('âŒ Veuillez sÃ©lectionner un fichier PDF', 'error');
        return;
    }
    if (file.type !== 'application/pdf') {
        afficherMessage('âŒ Le fichier doit Ãªtre un PDF', 'error');
        return;
    }
    if (!titreInput.value.trim()) {
        afficherMessage('âŒ Veuillez donner un titre au document', 'error');
        return;
    }
    
    console.log('ğŸ“„ Fichier valide:', file.name, file.size, 'bytes');
    
    const reader = new FileReader();
    reader.onerror = function(error) {
        console.error('âŒ Erreur lecture fichier:', error);
        afficherMessage('âŒ Erreur lors de la lecture du fichier', 'error');
    };
    
    reader.onload = function(e) {
        try {
            console.log('ğŸ“„ Lecture terminÃ©e, sauvegarde...');
            
            // Charger les documents existants avec la BONNE clÃ©
            const documents = JSON.parse(localStorage.getItem('documentsData') || '[]');
            console.log('ğŸ“„ Documents existants:', documents.length);
            
            // CrÃ©er le nouveau document avec la structure CORRECTE
            const nouveauDocument = {
                title: titreInput.value.trim(),
                filename: file.name,
                description: descriptionInput.value.trim() || 'Aucune description',
                category: categorieSelect.value,
                uploadDate: new Date().toISOString(),
                fileData: e.target.result, // DonnÃ©es base64 du PDF
                fileSize: file.size
            };
            
            documents.push(nouveauDocument);
            
            // Sauvegarder avec la BONNE clÃ© : documentsData
            localStorage.setItem('documentsData', JSON.stringify(documents));
            
            console.log('âœ… Document sauvegardÃ© ! Total:', documents.length);
            console.log('âœ… DonnÃ©es sauvegardÃ©es sous la clÃ©: documentsData');
            
            afficherMessage('âœ… Document uploadÃ© avec succÃ¨s ! Visible sur la page Documents.');
            
            // RÃ©initialiser le formulaire
            fileInput.value = '';
            titreInput.value = '';
            descriptionInput.value = '';
            categorieSelect.value = 'reglement-general';
            
            // RafraÃ®chir l'affichage
            afficherPDFs();
            
        } catch (error) {
            console.error('âŒ Erreur sauvegarde:', error);
            afficherMessage('âŒ Erreur lors de la sauvegarde: ' + error.message, 'error');
        }
    };
    
    reader.readAsDataURL(file);
}

function afficherPDFs() {
    console.log('ğŸ”„ Affichage des documents...');
    
    // Charger avec la BONNE clÃ©
    const documents = JSON.parse(localStorage.getItem('documentsData') || '[]');
    console.log('ğŸ“„ Nombre de documents trouvÃ©s:', documents.length);
    
    const liste = document.getElementById('liste-pdf');
    
    if (documents.length === 0) {
        liste.innerHTML = `
            <div style="padding: 2rem; text-align: center; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ddd;">
                <p style="font-size: 1.2rem; color: #999; margin: 0;">ğŸ“­ Aucun document disponible</p>
                <p style="color: #999; margin-top: 0.5rem;">Uploadez votre premier document ci-dessus</p>
            </div>
        `;
        console.log('âš ï¸ Aucun document Ã  afficher');
    } else {
        console.log('âœ… Affichage de', documents.length, 'document(s)');
        
        const categorieLabels = {
            'reglement-general': 'ğŸ“œ RÃ¨glement GÃ©nÃ©ral',
            'juges-arbitres': 'ğŸ‘” Juges & Arbitres',
            'criteres-notation': 'âœ… CritÃ¨res de Notation',
            'procedures': 'âš™ï¸ ProcÃ©dures',
            'nouveautes': 'â­ NouveautÃ©s',
            'autres': 'ğŸ“ Autres'
        };
        
        liste.innerHTML = '<h3 style="margin-bottom: 1rem;">ğŸ“‹ Documents disponibles :</h3>' + 
            documents.map((doc, index) => {
                console.log(`  - Document ${index + 1}: ${doc.title}`);
                const categorieLabel = categorieLabels[doc.category] || doc.category;
                const dateObj = new Date(doc.uploadDate);
                const dateFormatee = dateObj.toLocaleDateString('fr-FR');
                const tailleFormatee = (doc.fileSize / 1024 / 1024).toFixed(2) + ' Mo';
                
                return `
                <div class="pdf-item">
                    <div class="pdf-info">
                        <div class="pdf-title">ğŸ“„ ${doc.title}</div>
                        <div style="color: #555; margin: 0.5rem 0;">${doc.description}</div>
                        <div class="pdf-meta">
                            <span class="pdf-category">${categorieLabel}</span>
                            <span>ğŸ“… ${dateFormatee}</span>
                            <span style="margin-left: 1rem;">ğŸ’¾ ${tailleFormatee}</span>
                        </div>
                    </div>
                    <div class="pdf-actions">
                        <a href="${doc.fileData}" download="${doc.filename}" 
                           style="background: #3498db; color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none;">
                            ğŸ“¥ TÃ©lÃ©charger
                        </a>
                        <button onclick="supprimerDocument(${index})" 
                                style="background: #e74c3c; padding: 0.5rem 1rem; font-size: 0.9rem;">
                            ğŸ—‘ï¸ Supprimer
                        </button>
                    </div>
                </div>
            `}).join('');
    }
}

function supprimerDocument(index) {
    if (confirm("âš ï¸ Supprimer dÃ©finitivement ce document ?")) {
        const documents = JSON.parse(localStorage.getItem('documentsData') || '[]');
        const docSupprime = documents[index];
        documents.splice(index, 1);
        localStorage.setItem('documentsData', JSON.stringify(documents));
        console.log('ğŸ—‘ï¸ Document supprimÃ©:', docSupprime.title);
        afficherPDFs();
        afficherMessage('âœ… Document supprimÃ©.');
    }
}

function afficherMessage(message, type = 'success') {
    const msgElement = document.getElementById('message');
    msgElement.textContent = message;
    msgElement.className = type;
    msgElement.style.display = 'block';
    setTimeout(() => { msgElement.style.display = 'none'; }, 4000);
}

// ===== SYSTÃˆME EXPORT/IMPORT =====

// Afficher les informations sur les donnÃ©es
function afficherInfoSauvegarde() {
    const info = document.getElementById('info-sauvegarde');
    
    // Compter les Ã©lÃ©ments
    let nbGrades = 0;
    let nbTechniques = 0;
    let nbKatas = 0;
    let nbPhilo = 0;
    let nbDocuments = 0;
    
    GRADES.forEach(grade => {
        if (localStorage.getItem('grade-' + grade)) nbGrades++;
    });
    
    ['1er-dan', '2eme-dan', '3eme-dan', '4-5-6-dan', '20-attaques'].forEach(tech => {
        if (localStorage.getItem('technique-' + tech)) nbTechniques++;
    });
    
    ['nage-no-kata', 'katame-no-kata', 'kime-no-kata', 'goshin-jitsu', 'ju-no-kata', 'itsutsu-no-kata', 'koshiki-no-kata', 'gonosen'].forEach(kata => {
        if (localStorage.getItem('kata-' + kata)) nbKatas++;
    });
    
    ['shin-gi-tai', 'ethique', 'principes', 'histoire'].forEach(philo => {
        if (localStorage.getItem('philo-' + philo)) nbPhilo++;
    });
    
    const documents = JSON.parse(localStorage.getItem('documentsData') || '[]');
    nbDocuments = documents.length;
    
    // Calculer la taille totale
    let tailleTotal = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            tailleTotal += localStorage[key].length + key.length;
        }
    }
    const tailleMo = (tailleTotal / 1024 / 1024).toFixed(2);
    
    info.innerHTML = `
        <p><strong>ğŸ“Š Statistiques actuelles :</strong></p>
        <ul>
            <li>ğŸ¥‹ Grades : ${nbGrades} / 6</li>
            <li>ğŸ’ª Techniques : ${nbTechniques} / 5</li>
            <li>ğŸ“¿ Katas : ${nbKatas} / 8</li>
            <li>ğŸ§  Philosophie : ${nbPhilo} / 4</li>
            <li>ğŸ“ Sections rÃ¨glement : ${localStorage.getItem('reglement-general') ? 'âœ…' : 'âŒ'}</li>
            <li>ğŸ“„ Documents PDF : ${nbDocuments}</li>
        </ul>
        <p><strong>ğŸ’¾ Taille totale des donnÃ©es :</strong> ${tailleMo} Mo</p>
        <p style="margin-top: 1rem; padding: 1rem; background: #fff; border-radius: 6px;">
            <strong>ğŸ’¡ Conseil :</strong> Faites une sauvegarde avant toute modification importante !
        </p>
    `;
}

// Exporter toutes les donnÃ©es
function exporterTout() {
    console.log('ğŸ“¤ DÃ©but de l\'export...');
    
    try {
        const sauvegarde = {
            version: '1.0',
            date: new Date().toISOString(),
            site: 'grades-judo',
            donnees: {}
        };
        
        // Exporter TOUTES les clÃ©s du localStorage
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                // Ignorer la session
                if (key !== 'grades_judo_session') {
                    sauvegarde.donnees[key] = localStorage[key];
                }
            }
        }
        
        // CrÃ©er le fichier
        const json = JSON.stringify(sauvegarde, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Nom du fichier avec date
        const date = new Date();
        const nomFichier = `grades-judo-backup-${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}.json`;
        
        // TÃ©lÃ©charger
        const a = document.createElement('a');
        a.href = url;
        a.download = nomFichier;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        console.log('âœ… Export rÃ©ussi !');
        afficherMessage('âœ… Sauvegarde tÃ©lÃ©chargÃ©e avec succÃ¨s ! Fichier : ' + nomFichier);
        
    } catch (error) {
        console.error('âŒ Erreur export:', error);
        afficherMessage('âŒ Erreur lors de l\'export : ' + error.message, 'error');
    }
}

// Importer une sauvegarde
function importerTout() {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    
    if (!file) {
        afficherMessage('âŒ Veuillez sÃ©lectionner un fichier de sauvegarde', 'error');
        return;
    }
    
    if (!file.name.endsWith('.json')) {
        afficherMessage('âŒ Le fichier doit Ãªtre au format .json', 'error');
        return;
    }
    
    if (!confirm('âš ï¸ ATTENTION !\n\nCette opÃ©ration va REMPLACER toutes vos donnÃ©es actuelles par celles de la sauvegarde.\n\nVoulez-vous continuer ?')) {
        return;
    }
    
    console.log('ğŸ“¥ DÃ©but de l\'import...');
    
    const reader = new FileReader();
    
    reader.onerror = function() {
        console.error('âŒ Erreur lecture fichier');
        afficherMessage('âŒ Erreur lors de la lecture du fichier', 'error');
    };
    
    reader.onload = function(e) {
        try {
            const sauvegarde = JSON.parse(e.target.result);
            
            // VÃ©rifier la structure
            if (!sauvegarde.donnees) {
                throw new Error('Format de sauvegarde invalide');
            }
            
            console.log('ğŸ“¦ Sauvegarde du', sauvegarde.date);
            console.log('ğŸ“Š Nombre de clÃ©s:', Object.keys(sauvegarde.donnees).length);
            
            // Supprimer toutes les anciennes donnÃ©es (sauf session)
            const keysToRemove = [];
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key) && key !== 'grades_judo_session') {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            // Importer les nouvelles donnÃ©es
            let compteur = 0;
            for (let key in sauvegarde.donnees) {
                localStorage.setItem(key, sauvegarde.donnees[key]);
                compteur++;
            }
            
            console.log('âœ… Import terminÃ© :', compteur, 'clÃ©s restaurÃ©es');
            
            afficherMessage('âœ… Sauvegarde restaurÃ©e avec succÃ¨s ! ' + compteur + ' Ã©lÃ©ments importÃ©s.');
            
            // RafraÃ®chir l'affichage
            setTimeout(() => {
                location.reload();
            }, 2000);
            
        } catch (error) {
            console.error('âŒ Erreur import:', error);
            afficherMessage('âŒ Erreur lors de l\'import : ' + error.message, 'error');
        }
    };
    
    reader.readAsText(file);
}
</script>
</body>
</html>
